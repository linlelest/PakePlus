<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI辩论平台 - 多智能体辩论系统</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00f0ff;
            --secondary-color: #ff00f0;
            --dark-bg: #0a0a1a;
            --darker-bg: #050510;
            --panel-bg: rgba(15, 15, 35, 0.8);
            --text-color: #e0e0ff;
            --border-color: #30305a;
            --positive-color: #00c8ff;
            --negative-color: #ff5c8d;
            --highlight-color: #7a00ff;
            --debate-space-bg: rgba(30, 30, 60, 0.6);
            --moderator-color: #7a00ff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 240, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 0, 240, 0.05) 0%, transparent 50%);
        }
        
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--dark-bg);
        }
        
        .nav-tabs {
            display: flex;
            gap: 15px;
        }
        
        .tab-btn {
            background: none;
            border: none;
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .tab-btn:hover::after {
            width: 80%;
        }
        
        .tab-btn.active {
            background: var(--panel-bg);
            color: var(--primary-color);
        }
        
        .tab-btn.active::after {
            width: 80%;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        
        .panel-title {
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(10, 10, 20, 0.7);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.2);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--highlight-color));
            color: var(--dark-bg);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 240, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 240, 255, 0.4);
        }
        
        .btn-secondary {
            background: var(--panel-bg);
            color: var(--primary-color);
            box-shadow: none;
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: rgba(30, 30, 60, 0.8);
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff5c8d, #ff006a);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(255, 92, 141, 0.4);
        }
        
        .ai-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .ai-card {
            background: rgba(20, 20, 40, 0.6);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .ai-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            border-color: var(--primary-color);
        }
        
        .ai-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }
        
        .ai-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .ai-meta {
            font-size: 14px;
            color: rgba(224, 224, 255, 0.7);
            margin-bottom: 15px;
        }
        
        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 12px;
        }
        
        /* Debate Arena Styles */
        .debate-arena {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .debate-main {
            display: flex;
            gap: 30px;
            height: calc(100vh - 300px);
        }
        
        .team-container {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .debate-space {
            flex: 1;
            background: var(--debate-space-bg);
            border-radius: 10px;
            padding: 20px;
            min-height: 600px;
            position: relative;
            overflow-y: auto;
            height: 100%;
        }
        
        .team-header {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .team-affirmative {
            background: linear-gradient(90deg, rgba(0, 200, 255, 0.1), rgba(0, 200, 255, 0.3));
            border: 1px solid var(--positive-color);
            color: var(--positive-color);
        }
        
        .team-negative {
            background: linear-gradient(90deg, rgba(255, 92, 141, 0.1), rgba(255, 92, 141, 0.3));
            border: 1px solid var(--negative-color);
            color: var(--negative-color);
        }
        
        .team-members {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
        }
        
        .debater-seat {
            background: rgba(20, 20, 40, 0.6);
            border-radius: 8px;
            padding: 20px;
            border: 2px dashed var(--border-color);
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .debater-seat:hover {
            border-color: var(--primary-color);
            background: rgba(30, 30, 60, 0.8);
        }
        
        .debater-seat.occupied {
            border-style: solid;
            border-color: var(--highlight-color);
            background: rgba(30, 30, 60, 0.8);
        }
        
        .debater-seat.occupied:hover {
            border-color: var(--primary-color);
        }
        
        .seat-label {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 12px;
            color: rgba(224, 224, 255, 0.7);
        }
        
        .debater-info {
            text-align: center;
            width: 100%;
        }
        
        .debater-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .debater-model {
            font-size: 14px;
            color: rgba(224, 224, 255, 0.7);
        }
        
        .debater-instructions {
            margin-top: 10px;
            width: 100%;
        }
        
        .debater-instructions textarea {
            width: 100%;
            min-height: 60px;
            font-size: 12px;
            padding: 8px;
            background: rgba(10, 10, 20, 0.5);
        }
        
        /* Debate Space Styles */
        .debate-message {
            position: relative;
            max-width: 80%;
            padding: 15px;
            border-radius: 8px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 10;
            margin-bottom: 15px;
        }
        
        .debate-message.full {
            width: 100%;
            min-height: 150px;
            opacity: 1;
        }
        
        .debate-message.collapsed {
            width: 200px;
            height: 60px;
            overflow: hidden;
            opacity: 0.7;
            cursor: pointer;
        }
        
        .debate-message.collapsed:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .debate-message-affirmative {
            border-left: 4px solid var(--positive-color);
            margin-right: auto;
        }
        
        .debate-message-negative {
            border-left: 4px solid var(--negative-color);
            margin-left: auto;
        }
        
        .debate-message-moderator {
            border-left: 4px solid var(--moderator-color);
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        
        .debate-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .debate-message-sender {
            color: var(--primary-color);
        }
        
        .debate-message-affirmative .debate-message-sender {
            color: var(--positive-color);
        }
        
        .debate-message-negative .debate-message-sender {
            color: var(--negative-color);
        }
        
        .debate-message-moderator .debate-message-sender {
            color: var(--moderator-color);
        }
        
        .debate-message-time {
            color: rgba(224, 224, 255, 0.5);
            font-size: 12px;
        }
        
        .debate-message-content {
            line-height: 1.6;
        }
        
        .debate-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .debate-topic {
            text-align: center;
            font-size: 22px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(0, 200, 255, 0.1);
            border-left: 4px solid var(--primary-color);
            border-right: 4px solid var(--primary-color);
            font-family: 'Orbitron', sans-serif;
        }
        
        /* Debate History Styles */
        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .history-card {
            background: rgba(20, 20, 40, 0.6);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            border-color: var(--primary-color);
        }
        
        .history-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }
        
        .history-topic {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .history-meta {
            font-size: 14px;
            color: rgba(224, 224, 255, 0.7);
            margin-bottom: 15px;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 15, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--panel-bg);
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        .modal-title {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .round-details {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .round-side {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
        }
        
        .round-affirmative {
            background: rgba(0, 200, 255, 0.1);
            border-left: 4px solid var(--positive-color);
        }
        
        .round-negative {
            background: rgba(255, 92, 141, 0.1);
            border-left: 4px solid var(--negative-color);
        }
        
        .round-side-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .round-affirmative .round-side-header {
            color: var(--positive-color);
        }
        
        .round-negative .round-side-header {
            color: var(--negative-color);
        }
        
        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .file-upload-area.highlight {
            border-color: var(--primary-color);
            background: rgba(0, 240, 255, 0.05);
        }
        
        .file-upload-instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 20, 40, 0.6);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .file-upload-example {
            background: rgba(30, 30, 60, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            text-align: left;
            font-size: 13px;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        /* Bulk Assign Modal */
        .bulk-assign-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .bulk-ai-list {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
        }
        
        .bulk-seat-list {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
        }
        
        .bulk-ai-item, .bulk-seat-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(20, 20, 40, 0.6);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bulk-ai-item:hover, .bulk-seat-item:hover {
            background: rgba(30, 30, 60, 0.8);
        }
        
        .bulk-ai-item.selected, .bulk-seat-item.selected {
            background: rgba(0, 200, 255, 0.2);
            border-left: 3px solid var(--positive-color);
        }
        
        /* Checkbox styles */
        .checkbox-container {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }
        
        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: rgba(10, 10, 20, 0.7);
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }
        
        .checkbox-container:hover input ~ .checkmark {
            background-color: rgba(30, 30, 60, 0.8);
        }
        
        .checkbox-container input:checked ~ .checkmark {
            background-color: var(--positive-color);
        }
        
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }
        
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        
        .checkbox-container .checkmark:after {
            left: 7px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid var(--dark-bg);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        /* Mode Explanation Styles */
        .mode-explanation {
            background: rgba(20, 20, 40, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .debate-main {
                flex-direction: column;
                height: auto;
            }
            
            .team-container {
                flex: 1;
            }
            
            .debate-space {
                min-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .ai-list, .history-list {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .debate-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .round-details {
                flex-direction: column;
            }
            
            .bulk-assign-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">AI</div>
                <h1>AI辩论平台</h1>
            </div>
            <div class="nav-tabs">
                <button class="tab-btn active" data-tab="debate">辩论竞技场</button>
                <button class="tab-btn" data-tab="settings">AI设置</button>
                <button class="tab-btn" data-tab="moderator">主持人设置</button>
                <button class="tab-btn" data-tab="topic">辩论主题</button>
                <button class="tab-btn" data-tab="history">历史记录</button>
            </div>
        </header>
        
        <!-- Debate Arena Tab -->
        <div id="debate" class="tab-content active">
            <div class="debate-arena">
                <div class="panel">
                    <h2 class="debate-topic" id="current-topic">尚未设置辩论主题</h2>
                    
                    <div class="debate-main">
                        <!-- Affirmative Team -->
                        <div class="team-container">
                            <div class="team-header team-affirmative">正方</div>
                            <div class="team-members">
                                <div class="debater-seat" data-position="affirmative-1" onclick="openAISelector(this)">
                                    <span class="seat-label">一辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                                <div class="debater-seat" data-position="affirmative-2" onclick="openAISelector(this)">
                                    <span class="seat-label">二辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                                <div class="debater-seat" data-position="affirmative-3" onclick="openAISelector(this)">
                                    <span class="seat-label">三辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                                <div class="debater-seat" data-position="affirmative-4" onclick="openAISelector(this)">
                                    <span class="seat-label">四辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Debate Space -->
                        <div class="debate-space" id="debate-space">
                            <div class="debate-message" style="text-align: center;">
                                辩论空间 - 这里将展示辩论内容
                            </div>
                        </div>
                        
                        <!-- Negative Team -->
                        <div class="team-container">
                            <div class="team-header team-negative">反方</div>
                            <div class="team-members">
                                <div class="debater-seat" data-position="negative-1" onclick="openAISelector(this)">
                                    <span class="seat-label">一辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                                <div class="debater-seat" data-position="negative-2" onclick="openAISelector(this)">
                                    <span class="seat-label">二辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                                <div class="debater-seat" data-position="negative-3" onclick="openAISelector(this)">
                                    <span class="seat-label">三辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                                <div class="debater-seat" data-position="negative-4" onclick="openAISelector(this)">
                                    <span class="seat-label">四辩</span>
                                    <div class="debater-info">
                                        <div class="debater-name">点击选择AI</div>
                                        <div class="debater-model">未分配</div>
                                    </div>
                                    <div class="debater-instructions" style="display: none;">
                                        <textarea placeholder="独家提示词 (可选)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="debate-controls">
                        <button class="btn" onclick="startDebate()">开始辩论</button>
                        <button class="btn btn-secondary" onclick="restartDebate()">重新开始辩论</button>
                        <button class="btn btn-secondary" onclick="resetDebate()">重置</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    AI设置
                </h2>
                
                <form id="ai-settings-form">
                    <div class="form-group">
                        <label for="ai-name">AI昵称</label>
                        <input type="text" id="ai-name" placeholder="例如: GPT-4 辩论专家" required>
                        <small style="color: rgba(224, 224, 255, 0.7);">这是您给AI取的个性化名称</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-model">AI模型</label>
                        <select id="ai-model" required>
                            <option value="">选择模型</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="claude-2">Claude 2</option>
                            <option value="claude-3">Claude 3</option>
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="llama-2">Llama 2</option>
                            <option value="custom">自定义模型</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-model-group" style="display: none;">
                        <label for="custom-model-name">自定义模型名称</label>
                        <input type="text" id="custom-model-name" placeholder="例如: chatgpt4o">
                        <small style="color: rgba(224, 224, 255, 0.7);">这是API调用时使用的实际模型名称</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-base-url">API基础URL</label>
                        <input type="text" id="ai-base-url" placeholder="例如: https://api.openai.com/v1" required>
                        <small style="color: rgba(224, 224, 255, 0.7);">请确保URL以/v1或/competition结尾</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-api-key">API密钥</label>
                        <input type="password" id="ai-api-key" placeholder="输入API密钥" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-instructions">特殊指令 (可选)</label>
                        <textarea id="ai-instructions" placeholder="为这个AI设置特殊的行为指令，例如辩论风格、知识偏好等"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn">保存AI配置</button>
                        <button type="button" class="btn btn-secondary" onclick="clearAISettingsForm()">清除</button>
                        <button type="button" class="btn btn-secondary" onclick="testAIConnection()">测试连接</button>
                    </div>
                </form>
            </div>
            
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M12 2C6.47 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                    已配置的AI列表
                </h2>
                
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="toggleBulkDeleteMode()">批量删除</button>
                    <button class="btn btn-secondary" id="bulk-delete-btn" style="display: none;" onclick="deleteSelectedAIs()">删除选中</button>
                </div>
                
                <div class="ai-list" id="ai-list">
                    <!-- AI cards will be added here dynamically -->
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    批量导入AI配置
                </h2>
                
                <div class="file-upload-area" id="file-upload-area">
                    <p>拖放文件到这里或点击上传</p>
                    <input type="file" id="ai-import-file" accept=".txt,.json" style="display: none;">
                    <button class="btn btn-secondary" onclick="document.getElementById('ai-import-file').click()">选择文件</button>
                    
                    <div class="file-upload-instructions">
                        <p>上传文本文件(.txt)或JSON文件(.json)批量添加AI配置</p>
                        <div class="file-upload-example">
# 示例文件格式 (每行一个配置项)
model_nickname: "我的ChatGPT4"
base_url: "https://api.openai.com/v1"
API_KEY: "sk-12345678910111213..."
model_name: "gpt-4"
instructions: "作为正方辩手，强调技术进步的积极影响"

model_nickname: "专业反方Claude"
base_url: "https://api.anthropic.com/v1"
API_KEY: "sk-ant-12345678910111213..."
model_name: "claude-3"
instructions: "作为反方辩手，关注伦理和社会影响问题"

# 说明:
# - model_nickname: 您给AI取的个性化名称
# - model_name: API调用时使用的实际模型名称
# - 其他字段必须与示例格式一致
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button class="btn" onclick="importAIConfigs()">导入配置</button>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                        <path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0-14c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/>
                    </svg>
                    备份AI配置
                </h2>
                
                <div class="form-group">
                    <button class="btn" onclick="exportAIConfigs('txt')">导出为TXT</button>
                    <button class="btn btn-secondary" onclick="exportAIConfigs('json')">导出为JSON</button>
                </div>
                
                <div class="file-upload-instructions">
                    <p>导出的文件可以用于在其他设备上导入这些AI配置</p>
                </div>
            </div>
        </div>
        
        <!-- Moderator Tab -->
        <div id="moderator" class="tab-content">
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
                    </svg>
                    主持人设置
                </h2>
                
                <form id="moderator-settings-form">
                    <div class="form-group">
                        <label for="moderator-name">主持人昵称</label>
                        <input type="text" id="moderator-name" placeholder="例如: 专业辩论主持人">
                    </div>
                    
                    <div class="form-group">
                        <label for="moderator-model">AI模型</label>
                        <select id="moderator-model">
                            <option value="">选择模型</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="claude-2">Claude 2</option>
                            <option value="claude-3">Claude 3</option>
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="llama-2">Llama 2</option>
                            <option value="custom">自定义模型</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="moderator-custom-model-group" style="display: none;">
                        <label for="moderator-custom-model-name">自定义模型名称</label>
                        <input type="text" id="moderator-custom-model-name" placeholder="例如: chatgpt4o">
                    </div>
                    
                    <div class="form-group">
                        <label for="moderator-base-url">API基础URL</label>
                        <input type="text" id="moderator-base-url" placeholder="例如: https://api.openai.com/v1">
                    </div>
                    
                    <div class="form-group">
                        <label for="moderator-api-key">API密钥</label>
                        <input type="password" id="moderator-api-key" placeholder="输入API密钥">
                    </div>
                    
                    <div class="form-group">
                        <label for="moderator-instructions">特殊指令 (可选)</label>
                        <textarea id="moderator-instructions" placeholder="为主持人设置特殊的行为指令"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn" onclick="saveModeratorSettings()">保存主持人配置</button>
                        <button type="button" class="btn btn-secondary" onclick="clearModeratorSettings()">清除</button>
                        <button type="button" class="btn btn-secondary" onclick="testModeratorConnection()">测试连接</button>
                    </div>
                </form>
                
                <div class="form-group" style="margin-top: 30px;">
                    <h3>主持人模式设置</h3>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="enableModeratorMode()">启用主持人模式</button>
                        <button type="button" class="btn btn-secondary" onclick="enableSummarizerMode()">启用总结者模式</button>
                    </div>
                    
                    <div class="mode-explanation" id="moderator-mode-explanation">
                        主持人模式的解释：此AI将作为主持人，在辩论开始前介绍双方选手，并且给出辩题。（主持人的开场需要喂给双方一辩）在辩论结束后，除了双方四辩的总结外，还需要单独的一个阶段，叫做"主持人的回顾"，在这个阶段这个主持人需要分别总结正方和反方的观点，并罗列成一条一条的。并作最后的总结与展望。（注意这个AI生成的内容不用显示3秒就隐藏。）
                    </div>
                    
                    <div class="mode-explanation" id="summarizer-mode-explanation" style="display: none;">
                        总结者模式的解释：总结每一次每一个辩手的发言（如正方一辩，当他发完言后，完整发言显示3秒，随后便缩小，这个时间第九位AI要快速的把这位选手的发言总结成10个字以内的小标题。并把这个小标题用作给这个小选项卡命名。当用户点击此选项卡后，弹出完整发言），并把总结作为该选项卡的显示内容。
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Topic Tab -->
        <div id="topic" class="tab-content">
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                        <path d="M7 12h2v5H7zm8-5h2v10h-2zm-4 7h2v3h-2zm0-4h2v2h-2z"/>
                    </svg>
                    辩论主题设置
                </h2>
                
                <div class="form-group">
                    <label for="debate-topic">辩论主题</label>
                    <textarea id="debate-topic" placeholder="输入辩论主题，例如: '人工智能的发展最终将有利于人类社会吗？'" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="debate-rules">辩论规则 (可选)</label>
                    <textarea id="debate-rules" placeholder="输入自定义辩论规则，留空则使用默认规则">1. 辩论分为立论、质询、自由辩论和总结四个阶段
2. 每方4位辩手，每位辩手有固定发言顺序
3. 每位辩手发言时间限制为2分钟
4. 质询阶段每位辩手可向对方提出一个问题
5. 自由辩论阶段双方交替发言，每次发言不超过30秒</textarea>
                </div>
                
                <div class="form-group">
                    <button class="btn" onclick="saveDebateTopic()">保存主题</button>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="panel">
                <h2 class="panel-title">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                        <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                    历史辩论记录
                </h2>
                
                <div class="history-list" id="history-list">
                    <!-- History cards will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Selector Modal -->
    <div class="modal" id="ai-selector-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('ai-selector-modal')">&times;</button>
            <h2 class="modal-title">选择AI辩手</h2>
            
            <div class="ai-list" id="modal-ai-list">
                <!-- AI cards for selection will be added here dynamically -->
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('ai-selector-modal')">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Assign Modal -->
    <div class="modal" id="bulk-assign-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('bulk-assign-modal')">&times;</button>
            <h2 class="modal-title">批量分配AI</h2>
            
            <div class="bulk-assign-container">
                <div class="bulk-ai-list" id="bulk-ai-list">
                    <h4>选择AI</h4>
                    <!-- AI list will be populated here -->
                </div>
                
                <div class="bulk-seat-list" id="bulk-seat-list">
                    <h4>选择座位</h4>
                    <!-- Seat list will be populated here -->
                </div>
            </div>
            
            <div class="form-group">
                <button class="btn" onclick="applyBulkAssignment()">应用分配</button>
                <button class="btn btn-secondary" onclick="closeModal('bulk-assign-modal')">取消</button>
            </div>
        </div>
    </div>
    
    <!-- Round Details Modal -->
    <div class="modal" id="round-details-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('round-details-modal')">&times;</button>
            <h2 class="modal-title">辩论详情</h2>
            
            <div id="round-details-content">
                <!-- Round details will be added here dynamically -->
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('round-details-modal')">关闭</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let ais = [];
        let debateTopic = '';
        let debateRules = '';
        let currentDebate = null;
        let debateHistory = [];
        let selectedSeat = null;
        let currentPhase = null;
        let debateInterval = null;
        let isBulkDeleteMode = false;
        let selectedAIsForDelete = [];
        let selectedAIForBulkAssign = null;
        let selectedSeatsForBulkAssign = [];
        let moderatorAI = null;
        let isModeratorMode = false;
        let isSummarizerMode = false;
        
        // Debate phases and their order
        const debatePhases = [
            { name: '开篇立论', duration: 180, rounds: 2 },
            { name: '质询环节', duration: 120, rounds: 2 },
            { name: '三辩盘问', duration: 90, rounds: 2 },
            { name: '质询小结', duration: 90, rounds: 2 },
            { name: '自由辩论', duration: 240, rounds: 8 },
            { name: '总结陈词', duration: 210, rounds: 2 }
        ];
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data from localStorage
            loadData();
            
            // Set up tab navigation
            setupTabs();
            
            // Set up model selection
            document.getElementById('ai-model').addEventListener('change', function() {
                document.getElementById('custom-model-group').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('moderator-model').addEventListener('change', function() {
                document.getElementById('moderator-custom-model-group').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
            
            // Set up file upload
            setupFileUpload();
            
            // Render AI list
            renderAIList();
            
            // Render history list
            renderHistoryList();
            
            // Set up form submission
            document.getElementById('ai-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAISettings();
            });
        });
        
        // Set up file upload
        function setupFileUpload() {
            const fileUploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('ai-import-file');
            
            // Handle drag and drop
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUploadArea.classList.add('highlight');
            });
            
            fileUploadArea.addEventListener('dragleave', function() {
                fileUploadArea.classList.remove('highlight');
            });
            
            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUploadArea.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                }
            });
            
            // Handle file selection
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    fileUploadArea.querySelector('p').textContent = `已选择文件: ${this.files[0].name}`;
                }
            });
        }
        
        // Tab navigation
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons and tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding tab
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Load data from localStorage
        function loadData() {
            const savedAIs = localStorage.getItem('aiDebatePlatform_ais');
            if (savedAIs) {
                ais = JSON.parse(savedAIs);
            }
            
            const savedTopic = localStorage.getItem('aiDebatePlatform_topic');
            if (savedTopic) {
                debateTopic = savedTopic;
                document.getElementById('current-topic').textContent = debateTopic;
                document.getElementById('debate-topic').value = debateTopic;
            }
            
            const savedRules = localStorage.getItem('aiDebatePlatform_rules');
            if (savedRules) {
                debateRules = savedRules;
                document.getElementById('debate-rules').value = debateRules;
            }
            
            const savedHistory = localStorage.getItem('aiDebatePlatform_history');
            if (savedHistory) {
                debateHistory = JSON.parse(savedHistory);
            }
            
            const savedModerator = localStorage.getItem('aiDebatePlatform_moderator');
            if (savedModerator) {
                moderatorAI = JSON.parse(savedModerator);
                document.getElementById('moderator-name').value = moderatorAI.name || '';
                document.getElementById('moderator-model').value = moderatorAI.model || '';
                document.getElementById('moderator-base-url').value = moderatorAI.baseUrl || '';
                document.getElementById('moderator-api-key').value = moderatorAI.apiKey || '';
                document.getElementById('moderator-instructions').value = moderatorAI.instructions || '';
                
                if (moderatorAI.model === 'custom') {
                    document.getElementById('moderator-custom-model-group').style.display = 'block';
                    document.getElementById('moderator-custom-model-name').value = moderatorAI.customModelName || '';
                }
                
                isModeratorMode = moderatorAI.mode === 'moderator';
                isSummarizerMode = moderatorAI.mode === 'summarizer';
                
                if (isModeratorMode) {
                    document.getElementById('summarizer-mode-explanation').style.display = 'none';
                    document.getElementById('moderator-mode-explanation').style.display = 'block';
                } else if (isSummarizerMode) {
                    document.getElementById('moderator-mode-explanation').style.display = 'none';
                    document.getElementById('summarizer-mode-explanation').style.display = 'block';
                }
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('aiDebatePlatform_ais', JSON.stringify(ais));
            localStorage.setItem('aiDebatePlatform_topic', debateTopic);
            localStorage.setItem('aiDebatePlatform_rules', debateRules);
            localStorage.setItem('aiDebatePlatform_history', JSON.stringify(debateHistory));
            if (moderatorAI) {
                localStorage.setItem('aiDebatePlatform_moderator', JSON.stringify(moderatorAI));
            }
        }
        
        // Render AI list
        function renderAIList() {
            const aiListContainer = document.getElementById('ai-list');
            const modalAIListContainer = document.getElementById('modal-ai-list');
            
            aiListContainer.innerHTML = '';
            modalAIListContainer.innerHTML = '';
            
            if (ais.length === 0) {
                aiListContainer.innerHTML = '<p>尚未配置任何AI，请在设置中添加。</p>';
                modalAIListContainer.innerHTML = '<p>尚未配置任何AI，请先在设置中添加。</p>';
                return;
            }
            
            ais.forEach((ai, index) => {
                const aiCard = document.createElement('div');
                aiCard.className = 'ai-card';
                
                if (isBulkDeleteMode) {
                    aiCard.innerHTML = `
                        <label class="checkbox-container">
                            <input type="checkbox" id="ai-checkbox-${index}" onchange="toggleAIForDelete(${index})">
                            <span class="checkmark"></span>
                            <div class="ai-name">${ai.name}</div>
                        </label>
                        <div class="ai-meta">
                            <div>模型: ${ai.model}</div>
                            <div>API: ${ai.baseUrl}</div>
                        </div>
                        ${ai.instructions ? `<div class="ai-meta">指令: ${ai.instructions.substring(0, 50)}${ai.instructions.length > 50 ? '...' : ''}</div>` : ''}
                    `;
                } else {
                    aiCard.innerHTML = `
                        <div class="ai-name">${ai.name}</div>
                        <div class="ai-meta">
                            <div>模型: ${ai.model}</div>
                            <div>API: ${ai.baseUrl}</div>
                        </div>
                        ${ai.instructions ? `<div class="ai-meta">指令: ${ai.instructions.substring(0, 50)}${ai.instructions.length > 50 ? '...' : ''}</div>` : ''}
                        <div class="ai-actions">
                            <button class="btn btn-sm" onclick="editAI(${index})">编辑</button>
                            <button class="btn btn-sm btn-secondary" onclick="openBulkAssignModal(${index})">批量分配</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAI(${index})">删除</button>
                        </div>
                    `;
                }
                
                const modalAICard = document.createElement('div');
                modalAICard.className = 'ai-card';
                modalAICard.innerHTML = `
                    <div class="ai-name">${ai.name}</div>
                    <div class="ai-meta">
                        <div>模型: ${ai.model}</div>
                        <div>API: ${ai.baseUrl}</div>
                    </div>
                    ${ai.instructions ? `<div class="ai-meta">指令: ${ai.instructions.substring(0, 50)}${ai.instructions.length > 50 ? '...' : ''}</div>` : ''}
                    <div class="ai-actions">
                        <button class="btn btn-sm" onclick="selectAIForSeat(${index})">选择此AI</button>
                    </div>
                `;
                
                aiListContainer.appendChild(aiCard);
                modalAIListContainer.appendChild(modalAICard);
            });
        }
        
        // Render history list
        function renderHistoryList() {
            const historyListContainer = document.getElementById('history-list');
            historyListContainer.innerHTML = '';
            
            if (debateHistory.length === 0) {
                historyListContainer.innerHTML = '<p>暂无历史辩论记录。</p>';
                return;
            }
            
            debateHistory.forEach((debate, index) => {
                const historyCard = document.createElement('div');
                historyCard.className = 'history-card';
                historyCard.innerHTML = `
                    <div class="history-topic">${debate.topic}</div>
                    <div class="history-meta">
                        <div>时间: ${new Date(debate.startTime).toLocaleString()}</div>
                        <div>持续时间: ${Math.floor((new Date(debate.endTime) - new Date(debate.startTime)) / 60000)} 分钟</div>
                        <div>回合数: ${debate.rounds.length}</div>
                    </div>
                    <div class="history-actions">
                        <button class="btn btn-sm" onclick="viewDebateHistory(${index})">查看详情</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDebateHistory(${index})">删除</button>
                    </div>
                `;
                
                historyListContainer.appendChild(historyCard);
            });
        }
        
        // Save moderator settings
        function saveModeratorSettings() {
            const name = document.getElementById('moderator-name').value;
            let model = document.getElementById('moderator-model').value;
            const baseUrl = document.getElementById('moderator-base-url').value;
            const apiKey = document.getElementById('moderator-api-key').value;
            const instructions = document.getElementById('moderator-instructions').value;
            
            if (model === 'custom') {
                model = document.getElementById('moderator-custom-model-name').value;
                if (!model) {
                    alert('请输入自定义模型名称！');
                    return;
                }
            }
            
            moderatorAI = {
                name,
                model,
                baseUrl,
                apiKey,
                instructions,
                mode: isModeratorMode ? 'moderator' : (isSummarizerMode ? 'summarizer' : '')
            };
            
            // Save to localStorage
            saveData();
            
            // Show success message
            addSystemMessage('主持人配置已保存。');
        }
        
        // Clear moderator settings
        function clearModeratorSettings() {
            document.getElementById('moderator-settings-form').reset();
            document.getElementById('moderator-custom-model-group').style.display = 'none';
            moderatorAI = null;
            isModeratorMode = false;
            isSummarizerMode = false;
            saveData();
        }
        
        // Enable moderator mode
        function enableModeratorMode() {
            isModeratorMode = true;
            isSummarizerMode = false;
            document.getElementById('summarizer-mode-explanation').style.display = 'none';
            document.getElementById('moderator-mode-explanation').style.display = 'block';
            addSystemMessage('已启用主持人模式');
        }
        
        // Enable summarizer mode
        function enableSummarizerMode() {
            isSummarizerMode = true;
            isModeratorMode = false;
            document.getElementById('moderator-mode-explanation').style.display = 'none';
            document.getElementById('summarizer-mode-explanation').style.display = 'block';
            addSystemMessage('已启用总结者模式');
        }
        
        // Test moderator connection
        async function testModeratorConnection() {
            const name = document.getElementById('moderator-name').value || '主持人AI';
            let model = document.getElementById('moderator-model').value;
            const baseUrl = document.getElementById('moderator-base-url').value;
            const apiKey = document.getElementById('moderator-api-key').value;
            
            if (!baseUrl || !apiKey) {
                alert('请填写API基础URL和API密钥！');
                return;
            }
            
            if (model === 'custom') {
                model = document.getElementById('moderator-custom-model-name').value;
                if (!model) {
                    alert('请输入自定义模型名称！');
                    return;
                }
            } else if (!model) {
                alert('请选择AI模型！');
                return;
            }
            
            // Show testing message
            const testBtn = document.querySelector('#moderator-settings-form button[onclick="testModeratorConnection()"]');
            const originalText = testBtn.textContent;
            testBtn.textContent = '测试中...';
            testBtn.disabled = true;
            
            try {
                // Prepare test prompt
                const testPrompt = '番茄炒鸡蛋怎么做？控制在20个字以内。';
                
                // Call OpenAI API
                const response = await callOpenAIAPI({
                    name,
                    model,
                    baseUrl,
                    apiKey
                }, [
                    { role: "system", content: "你是一个有帮助的助手。" },
                    { role: "user", content: testPrompt }
                ]);
                
                // Check if response is valid
                if (response && response.trim().length > 0) {
                    addSystemMessage('测试正常，API连接成功。');
                } else {
                    addSystemMessage('测试失败：API返回了空响应。');
                }
            } catch (error) {
                console.error('测试失败:', error);
                
                if (error.message.includes('Unexpected token') || error.message.includes('JSON')) {
                    alert('测试失败。你的baseurl（即API基础URL）有问题，请检查是否在网址后面添加/v1，或者/competition。');
                } else {
                    alert(`测试失败: ${error.message}\n\n以上为错误信息，请百度解决方法。`);
                }
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // Import AI configs from file
        function importAIConfigs() {
            const fileInput = document.getElementById('ai-import-file');
            if (!fileInput.files.length) {
                alert('请先选择文件！');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedAIs = [];
                    
                    if (file.name.endsWith('.json')) {
                        // Parse JSON file
                        importedAIs = JSON.parse(content);
                    } else {
                        // Parse text file
                        const lines = content.split('\n');
                        let currentAI = {};
                        
                        for (const line of lines) {
                            if (line.trim() === '') {
                                if (Object.keys(currentAI).length > 0) {
                                    importedAIs.push(currentAI);
                                    currentAI = {};
                                }
                                continue;
                            }
                            
                            const parts = line.split(':').map(p => p.trim());
                            if (parts.length >= 2) {
                                const key = parts[0];
                                const value = parts.slice(1).join(':').trim().replace(/^"(.*)"$/, '$1');
                                
                                if (key === 'model_nickname') {
                                    currentAI.name = value;
                                } else if (key === 'base_url') {
                                    currentAI.baseUrl = value;
                                } else if (key === 'API_KEY') {
                                    currentAI.apiKey = value;
                                } else if (key === 'model_name') {
                                    currentAI.model = value;
                                } else if (key === 'instructions') {
                                    currentAI.instructions = value;
                                }
                            }
                        }
                        
                        if (Object.keys(currentAI).length > 0) {
                            importedAIs.push(currentAI);
                        }
                    }
                    
                    // Validate imported AIs
                    const validAIs = importedAIs.filter(ai => 
                        ai.name && ai.baseUrl && ai.apiKey && ai.model
                    );
                    
                    if (validAIs.length === 0) {
                        throw new Error('未找到有效的AI配置');
                    }
                    
                    // Add to existing AIs
                    ais = ais.concat(validAIs);
                    saveData();
                    renderAIList();
                    
                    addSystemMessage(`成功导入 ${validAIs.length} 个AI配置`);
                    fileInput.value = '';
                    document.getElementById('file-upload-area').querySelector('p').textContent = '拖放文件到这里或点击上传';
                } catch (error) {
                    console.error('导入失败:', error);
                    alert(`导入失败: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                alert('读取文件时出错');
            };
            
            reader.readAsText(file);
        }
        
        // Export AI configs
        function exportAIConfigs(format) {
            if (ais.length === 0) {
                alert('没有可导出的AI配置');
                return;
            }
            
            let content = '';
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            
            if (format === 'json') {
                content = JSON.stringify(ais, null, 2);
            } else {
                // TXT format
                content = ais.map(ai => {
                    return `model_nickname: "${ai.name}"\nbase_url: "${ai.baseUrl}"\nAPI_KEY: "${ai.apiKey}"\nmodel_name: "${ai.model}"\ninstructions: "${ai.instructions || ''}"\n`;
                }).join('\n');
            }
            
            const blob = new Blob([content], { type: format === 'json' ? 'application/json' : 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_debate_configs_${timestamp}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addSystemMessage(`AI配置已导出为${format.toUpperCase()}文件`);
        }
        
        // Save AI settings
        function saveAISettings() {
            const name = document.getElementById('ai-name').value;
            let model = document.getElementById('ai-model').value;
            const baseUrl = document.getElementById('ai-base-url').value;
            const apiKey = document.getElementById('ai-api-key').value;
            const instructions = document.getElementById('ai-instructions').value;
            
            if (model === 'custom') {
                model = document.getElementById('custom-model-name').value;
                if (!model) {
                    alert('请输入自定义模型名称！');
                    return;
                }
            }
            
            // Check if we're editing an existing AI
            const editingIndex = document.getElementById('ai-settings-form').getAttribute('data-editing');
            
            if (editingIndex !== null) {
                // Update existing AI
                ais[editingIndex] = {
                    name,
                    model,
                    baseUrl,
                    apiKey,
                    instructions
                };
            } else {
                // Add new AI
                ais.push({
                    name,
                    model,
                    baseUrl,
                    apiKey,
                    instructions
                });
            }
            
            // Save to localStorage and refresh UI
            saveData();
            renderAIList();
            clearAISettingsForm();
            
            // Show success message
            addSystemMessage('AI配置已保存。');
        }
        
        // Test AI connection
        async function testAIConnection() {
            const name = document.getElementById('ai-name').value || '测试AI';
            let model = document.getElementById('ai-model').value;
            const baseUrl = document.getElementById('ai-base-url').value;
            const apiKey = document.getElementById('ai-api-key').value;
            
            if (!baseUrl || !apiKey) {
                alert('请填写API基础URL和API密钥！');
                return;
            }
            
            if (model === 'custom') {
                model = document.getElementById('custom-model-name').value;
                if (!model) {
                    alert('请输入自定义模型名称！');
                    return;
                }
            } else if (!model) {
                alert('请选择AI模型！');
                return;
            }
            
            // Show testing message
            const testBtn = document.querySelector('#ai-settings-form button[onclick="testAIConnection()"]');
            const originalText = testBtn.textContent;
            testBtn.textContent = '测试中...';
            testBtn.disabled = true;
            
            try {
                // Prepare test prompt
                const testPrompt = '番茄炒鸡蛋怎么做？控制在20个字以内。';
                
                // Call OpenAI API
                const response = await callOpenAIAPI({
                    name,
                    model,
                    baseUrl,
                    apiKey
                }, [
                    { role: "system", content: "你是一个有帮助的助手。" },
                    { role: "user", content: testPrompt }
                ]);
                
                // Check if response is valid
                if (response && response.trim().length > 0) {
                    alert('测试正常');
                } else {
                    alert('测试失败：API返回了空响应。');
                }
            } catch (error) {
                console.error('测试失败:', error);
                
                if (error.message.includes('Unexpected token') || error.message.includes('JSON')) {
                    alert('测试失败。你的baseurl（即API基础URL）有问题，请检查是否在网址后面添加/v1，或者/competition。');
                } else {
                    alert(`测试失败: ${error.message}\n\n以上为错误信息，请百度解决方法。`);
                }
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // Clear AI settings form
        function clearAISettingsForm() {
            document.getElementById('ai-settings-form').reset();
            document.getElementById('ai-settings-form').removeAttribute('data-editing');
            document.getElementById('custom-model-group').style.display = 'none';
        }
        
        // Edit AI
        function editAI(index) {
            const ai = ais[index];
            
            document.getElementById('ai-name').value = ai.name;
            
            // Check if model is in the predefined list
            const modelSelect = document.getElementById('ai-model');
            const modelOptions = Array.from(modelSelect.options).map(opt => opt.value);
            
            if (modelOptions.includes(ai.model)) {
                modelSelect.value = ai.model;
                document.getElementById('custom-model-group').style.display = 'none';
            } else {
                modelSelect.value = 'custom';
                document.getElementById('custom-model-group').style.display = 'block';
                document.getElementById('custom-model-name').value = ai.model;
            }
            
            document.getElementById('ai-base-url').value = ai.baseUrl;
            document.getElementById('ai-api-key').value = ai.apiKey;
            document.getElementById('ai-instructions').value = ai.instructions || '';
            
            document.getElementById('ai-settings-form').setAttribute('data-editing', index);
            
            // Switch to settings tab
            document.querySelector('.tab-btn[data-tab="settings"]').click();
            
            // Scroll to form
            document.getElementById('ai-settings-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Delete AI
        function deleteAI(index) {
            if (confirm(`确定要删除AI "${ais[index].name}" 吗？`)) {
                ais.splice(index, 1);
                saveData();
                renderAIList();
                addSystemMessage('AI已删除。');
            }
        }
        
        // Toggle bulk delete mode
        function toggleBulkDeleteMode() {
            isBulkDeleteMode = !isBulkDeleteMode;
            selectedAIsForDelete = [];
            
            if (isBulkDeleteMode) {
                document.getElementById('bulk-delete-btn').style.display = 'inline-block';
            } else {
                document.getElementById('bulk-delete-btn').style.display = 'none';
            }
            
            renderAIList();
        }
        
        // Toggle AI for deletion
        function toggleAIForDelete(index) {
            const checkbox = document.getElementById(`ai-checkbox-${index}`);
            if (checkbox.checked) {
                selectedAIsForDelete.push(index);
            } else {
                selectedAIsForDelete = selectedAIsForDelete.filter(i => i !== index);
            }
        }
        
        // Delete selected AIs
        function deleteSelectedAIs() {
            if (selectedAIsForDelete.length === 0) {
                alert('请先选择要删除的AI！');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedAIsForDelete.length} 个AI吗？`)) {
                // Sort in descending order to avoid index issues
                selectedAIsForDelete.sort((a, b) => b - a);
                
                // Remove selected AIs
                selectedAIsForDelete.forEach(index => {
                    ais.splice(index, 1);
                });
                
                saveData();
                toggleBulkDeleteMode();
                renderAIList();
                addSystemMessage(`已删除 ${selectedAIsForDelete.length} 个AI配置。`);
            }
        }
        
        // Open bulk assign modal
        function openBulkAssignModal(aiIndex) {
            selectedAIForBulkAssign = aiIndex;
            selectedSeatsForBulkAssign = [];
            
            // Populate AI list
            const aiList = document.getElementById('bulk-ai-list');
            aiList.innerHTML = '<h4>选择AI</h4>';
            
            const aiItem = document.createElement('div');
            aiItem.className = 'bulk-ai-item selected';
            aiItem.innerHTML = `
                <div class="ai-name">${ais[aiIndex].name}</div>
                <div class="ai-meta">模型: ${ais[aiIndex].model}</div>
            `;
            aiList.appendChild(aiItem);
            
            // Populate seat list
            const seatList = document.getElementById('bulk-seat-list');
            seatList.innerHTML = '<h4>选择座位</h4>';
            
            const seats = [
                { position: 'affirmative-1', label: '正方一辩' },
                { position: 'affirmative-2', label: '正方二辩' },
                { position: 'affirmative-3', label: '正方三辩' },
                { position: 'affirmative-4', label: '正方四辩' },
                { position: 'negative-1', label: '反方一辩' },
                { position: 'negative-2', label: '反方二辩' },
                { position: 'negative-3', label: '反方三辩' },
                { position: 'negative-4', label: '反方四辩' }
            ];
            
            seats.forEach(seat => {
                const seatItem = document.createElement('div');
                seatItem.className = 'bulk-seat-item';
                seatItem.dataset.position = seat.position;
                seatItem.innerHTML = seat.label;
                seatItem.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const position = this.dataset.position;
                    if (this.classList.contains('selected')) {
                        if (!selectedSeatsForBulkAssign.includes(position)) {
                            selectedSeatsForBulkAssign.push(position);
                        }
                    } else {
                        selectedSeatsForBulkAssign = selectedSeatsForBulkAssign.filter(p => p !== position);
                    }
                });
                seatList.appendChild(seatItem);
            });
            
            // Show modal
            document.getElementById('bulk-assign-modal').style.display = 'flex';
        }
        
        // Apply bulk assignment
        function applyBulkAssignment() {
            if (selectedAIForBulkAssign === null || selectedSeatsForBulkAssign.length === 0) {
                alert('请选择至少一个座位！');
                return;
            }
            
            const ai = ais[selectedAIForBulkAssign];
            
            selectedSeatsForBulkAssign.forEach(position => {
                const seatElement = document.querySelector(`.debater-seat[data-position="${position}"]`);
                
                // Update seat UI
                seatElement.classList.add('occupied');
                seatElement.querySelector('.debater-name').textContent = ai.name;
                seatElement.querySelector('.debater-model').textContent = ai.model;
                
                // Show instructions textarea
                const instructionsArea = seatElement.querySelector('.debater-instructions');
                instructionsArea.style.display = 'block';
                instructionsArea.querySelector('textarea').value = ai.instructions || '';
                
                // Store AI index in seat data
                seatElement.setAttribute('data-ai-index', selectedAIForBulkAssign);
            });
            
            closeModal('bulk-assign-modal');
            addSystemMessage(`已将 ${ai.name} 分配到 ${selectedSeatsForBulkAssign.length} 个座位`);
        }
        
        // Save debate topic
        function saveDebateTopic() {
            debateTopic = document.getElementById('debate-topic').value;
            debateRules = document.getElementById('debate-rules').value;
            
            if (!debateTopic) {
                alert('请输入辩论主题！');
                return;
            }
            
            document.getElementById('current-topic').textContent = debateTopic;
            saveData();
            addSystemMessage(`辩论主题已设置为: "${debateTopic}"`);
        }
        
        // Open AI selector modal
        function openAISelector(seatElement) {
            selectedSeat = seatElement;
            document.getElementById('ai-selector-modal').style.display = 'flex';
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            selectedSeat = null;
            selectedAIForBulkAssign = null;
            selectedSeatsForBulkAssign = [];
        }
        
        // Select AI for seat
        function selectAIForSeat(aiIndex) {
            if (!selectedSeat) return;
            
            const ai = ais[aiIndex];
            
            // Update seat UI
            selectedSeat.classList.add('occupied');
            selectedSeat.querySelector('.debater-name').textContent = ai.name;
            selectedSeat.querySelector('.debater-model').textContent = ai.model;
            
            // Show instructions textarea
            const instructionsArea = selectedSeat.querySelector('.debater-instructions');
            instructionsArea.style.display = 'block';
            instructionsArea.querySelector('textarea').value = ai.instructions || '';
            
            // Store AI index in seat data
            selectedSeat.setAttribute('data-ai-index', aiIndex);
            
            // Close modal
            closeModal('ai-selector-modal');
            
            addSystemMessage(`已将 ${ai.name} 分配到 ${selectedSeat.getAttribute('data-position')} 位置`);
        }
        
        // Start debate
        async function startDebate() {
            if (!debateTopic) {
                alert('请先设置辩论主题！');
                document.querySelector('.tab-btn[data-tab="topic"]').click();
                return;
            }
            
            // Check if all seats are filled
            const seats = document.querySelectorAll('.debater-seat');
            let allFilled = true;
            
            seats.forEach(seat => {
                if (!seat.classList.contains('occupied')) {
                    allFilled = false;
                    addSystemMessage(`请为 ${seat.getAttribute('data-position')} 位置选择AI辩手`);
                }
            });
            
            if (!allFilled) {
                alert('请为所有辩手位置分配AI！');
                return;
            }
            
            // Start the debate
            currentDebate = {
                topic: debateTopic,
                rules: debateRules,
                startTime: new Date().toISOString(),
                status: 'in-progress',
                phases: [],
                currentPhaseIndex: 0,
                currentRound: 0,
                debaters: {
                    affirmative: [],
                    negative: []
                },
                summaries: []
            };
            
            // Get all debaters and their instructions
            document.querySelectorAll('.debater-seat[data-position^="affirmative"]').forEach(seat => {
                const aiIndex = seat.getAttribute('data-ai-index');
                if (aiIndex) {
                    const ai = {...ais[aiIndex]}; // Create a copy
                    const instructions = seat.querySelector('.debater-instructions textarea').value;
                    if (instructions) {
                        ai.instructions = instructions;
                    }
                    currentDebate.debaters.affirmative.push(ai);
                }
            });
            
            document.querySelectorAll('.debater-seat[data-position^="negative"]').forEach(seat => {
                const aiIndex = seat.getAttribute('data-ai-index');
                if (aiIndex) {
                    const ai = {...ais[aiIndex]}; // Create a copy
                    const instructions = seat.querySelector('.debater-instructions textarea').value;
                    if (instructions) {
                        ai.instructions = instructions;
                    }
                    currentDebate.debaters.negative.push(ai);
                }
            });
            
            // Disable seat selection
            seats.forEach(seat => {
                seat.style.pointerEvents = 'none';
            });
            
            // Disable start button
            document.querySelector('.debate-controls .btn').disabled = true;
            
            // Clear debate space
            document.getElementById('debate-space').innerHTML = '';
            
            // Add initial debate message
            addSystemMessage(`辩论开始！主题: "${debateTopic}"`);
            addSystemMessage(`辩论规则: ${debateRules || '使用新国辩标准规则'}`);
            
            // Start debate phases
            currentPhase = 0;
            
            // Add moderator introduction if available
            if (moderatorAI && isModeratorMode) {
                await addModeratorIntroduction();
            }
            
            await runDebatePhase();
        }
        
        // Restart debate
        function restartDebate() {
            if (!currentDebate) {
                alert('没有正在进行的辩论可以重新开始！');
                return;
            }
            
            if (confirm('确定要重新开始辩论吗？这将保留当前设置但重置辩论内容。')) {
                // Clear debate space
                document.getElementById('debate-space').innerHTML = '';
                
                // Reset debate state
                currentDebate.phases = [];
                currentDebate.summaries = [];
                currentDebate.startTime = new Date().toISOString();
                currentDebate.status = 'in-progress';
                currentPhase = 0;
                
                // Add initial message
                addSystemMessage(`辩论重新开始！主题: "${debateTopic}"`);
                
                // Start debate phases
                runDebatePhase();
            }
        }
        
        // Add moderator introduction
        async function addModeratorIntroduction() {
            const debateSpace = document.getElementById('debate-space');
            
            // Generate introduction
            const introduction = await generateAIReponse(moderatorAI, '主持人开场', 0);
            
            // Display introduction
            const introElement = document.createElement('div');
            introElement.className = 'debate-message debate-message-moderator full';
            introElement.innerHTML = `
                <div class="debate-message-header">
                    <div class="debate-message-sender">主持人</div>
                    <div class="debate-message-time">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="debate-message-content">${introduction}</div>
            `;
            
            debateSpace.appendChild(introElement);
            debateSpace.scrollTop = debateSpace.scrollHeight;
            
            // Add to debate record
            currentDebate.phases.push({
                phase: '主持人开场',
                round: 0,
                side: 'moderator',
                speaker: '主持人',
                message: introduction,
                timestamp: new Date().toISOString(),
                isQuestion: false
            });
            
            // Add delay before debate starts
            await new Promise(resolve => setTimeout(resolve, 3000));
        }
        
        // Run debate phase
        async function runDebatePhase() {
            if (!currentDebate || currentDebate.status !== 'in-progress') return;
            
            const phase = debatePhases[currentPhase];
            currentDebate.currentPhase = phase.name;
            
            // Announce new phase
            const phaseMessage = document.createElement('div');
            phaseMessage.className = 'debate-message debate-message-moderator full';
            phaseMessage.innerHTML = `
                <div class="debate-message-header">
                    <div class="debate-message-sender">阶段</div>
                    <div class="debate-message-time">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="debate-message-content" style="font-weight: bold;">=== ${phase.name} ===</div>
            `;
            
            document.getElementById('debate-space').appendChild(phaseMessage);
            document.getElementById('debate-space').scrollTop = document.getElementById('debate-space').scrollHeight;
            
            // Determine the number of rounds for this phase
            const rounds = phase.rounds;
            
            // Run each round in the phase
            for (let round = 0; round < rounds; round++) {
                currentDebate.currentRound = round;
                
                let speaker, side, opponent = null;
                let isQuestion = false;
                
                // Determine speaker based on phase and round
                switch (phase.name) {
                    case '开篇立论':
                        if (round === 0) {
                            speaker = currentDebate.debaters.affirmative[0]; // 正方一辩
                            side = 'affirmative';
                        } else {
                            speaker = currentDebate.debaters.negative[0]; // 反方一辩
                            side = 'negative';
                        }
                        break;
                        
                    case '质询环节':
                        if (round === 0) {
                            // 反方二辩质询正方一辩
                            speaker = currentDebate.debaters.negative[1]; // 反方二辩
                            opponent = currentDebate.debaters.affirmative[0]; // 正方一辩
                            side = 'negative';
                            isQuestion = true;
                        } else {
                            // 正方二辩质询反方一辩
                            speaker = currentDebate.debaters.affirmative[1]; // 正方二辩
                            opponent = currentDebate.debaters.negative[0]; // 反方一辩
                            side = 'affirmative';
                            isQuestion = true;
                        }
                        break;
                        
                    case '三辩盘问':
                        if (round === 0) {
                            // 反方三辩盘问正方（除三辩外）
                            speaker = currentDebate.debaters.negative[2]; // 反方三辩
                            // 随机选择正方一、二、四辩中的一个
                            const availableAffirmative = [...currentDebate.debaters.affirmative];
                            availableAffirmative.splice(2, 1); // 移除三辩
                            opponent = availableAffirmative[Math.floor(Math.random() * availableAffirmative.length)];
                            side = 'negative';
                            isQuestion = true;
                        } else {
                            // 正方三辩盘问反方（除三辩外）
                            speaker = currentDebate.debaters.affirmative[2]; // 正方三辩
                            // 随机选择反方一、二、四辩中的一个
                            const availableNegative = [...currentDebate.debaters.negative];
                            availableNegative.splice(2, 1); // 移除三辩
                            opponent = availableNegative[Math.floor(Math.random() * availableNegative.length)];
                            side = 'affirmative';
                            isQuestion = true;
                        }
                        break;
                        
                    case '质询小结':
                        if (round === 0) {
                            // 反方二辩小结
                            speaker = currentDebate.debaters.negative[1]; // 反方二辩
                            side = 'negative';
                        } else {
                            // 正方二辩小结
                            speaker = currentDebate.debaters.affirmative[1]; // 正方二辩
                            side = 'affirmative';
                        }
                        break;
                        
                    case '自由辩论':
                        // Alternate between sides
                        if (round % 2 === 0) {
                            // 正方发言
                            const speakerIndex = Math.floor(round / 2) % 4;
                            speaker = currentDebate.debaters.affirmative[speakerIndex];
                            side = 'affirmative';
                        } else {
                            // 反方发言
                            const speakerIndex = Math.floor((round - 1) / 2) % 4;
                            speaker = currentDebate.debaters.negative[speakerIndex];
                            side = 'negative';
                        }
                        break;
                        
                    case '总结陈词':
                        if (round === 0) {
                            // 反方四辩总结
                            speaker = currentDebate.debaters.negative[3]; // 反方四辩
                            side = 'negative';
                        } else {
                            // 正方四辩总结
                            speaker = currentDebate.debaters.affirmative[3]; // 正方四辩
                            side = 'affirmative';
                        }
                        break;
                }
                
                if (speaker) {
                    const message = await generateAIReponse(speaker, phase.name, round, opponent, isQuestion);
                    
                    // Add to debate record
                    const roundData = {
                        phase: phase.name,
                        round: round,
                        side,
                        speaker: speaker.name,
                        message,
                        timestamp: new Date().toISOString(),
                        isQuestion
                    };
                    
                    if (opponent) {
                        roundData.opponent = opponent.name;
                    }
                    
                    currentDebate.phases.push(roundData);
                    
                    // Display in debate space
                    displayDebateMessage(roundData);
                    
                    // Generate summary if moderator is available and in summarizer mode
                    if (moderatorAI && isSummarizerMode && !isQuestion) {
                        await generateSummary(roundData);
                    }
                    
                    // Add delay between rounds
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            // Move to next phase
            currentPhase++;
            
            if (currentPhase < debatePhases.length) {
                // Continue to next phase after delay
                debateInterval = setTimeout(runDebatePhase, 3000);
            } else {
                // Debate ended, add moderator conclusion if available
                if (moderatorAI && isModeratorMode) {
                    await addModeratorConclusion();
                }
                endDebate();
            }
        }
        
        // Generate summary for the round
        async function generateSummary(roundData) {
            try {
                const prompt = `请用10个字以内总结以下${roundData.side === 'affirmative' ? '正方' : '反方'}辩手的发言:\n\n${roundData.message}`;
                
                const summary = await callOpenAIAPI(moderatorAI, [
                    { role: "system", content: "你是一位专业的辩论总结人，需要用简短的语言总结辩手的发言。" },
                    { role: "user", content: prompt }
                ]);
                
                // Store summary
                currentDebate.summaries.push({
                    phase: roundData.phase,
                    round: roundData.round,
                    side: roundData.side,
                    speaker: roundData.speaker,
                    summary,
                    timestamp: new Date().toISOString()
                });
                
                // Display summary
                const summaryElement = document.createElement('div');
                summaryElement.className = `debate-message debate-message-${roundData.side} collapsed`;
                summaryElement.style.width = '200px';
                summaryElement.style.margin = '0 auto';
                summaryElement.style.textAlign = 'center';
                summaryElement.style.backgroundColor = 'rgba(122, 0, 255, 0.1)';
                summaryElement.innerHTML = `
                    <div class="debate-message-header">
                        <div class="debate-message-sender">总结</div>
                    </div>
                    <div class="debate-message-content">${summary}</div>
                `;
                
                summaryElement.addEventListener('click', function() {
                    showRoundDetails(currentDebate.phases.length - 1);
                });
                
                document.getElementById('debate-space').appendChild(summaryElement);
                document.getElementById('debate-space').scrollTop = document.getElementById('debate-space').scrollHeight;
                
            } catch (error) {
                console.error('生成总结失败:', error);
            }
        }
        
        // Add moderator conclusion
        async function addModeratorConclusion() {
            const debateSpace = document.getElementById('debate-space');
            
            // Generate conclusion
            const conclusion = await generateAIReponse(moderatorAI, '主持人总结', 0);
            
            // Display conclusion
            const conclusionElement = document.createElement('div');
            conclusionElement.className = 'debate-message debate-message-moderator full';
            conclusionElement.innerHTML = `
                <div class="debate-message-header">
                    <div class="debate-message-sender">主持人</div>
                    <div class="debate-message-time">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="debate-message-content">${conclusion}</div>
            `;
            
            debateSpace.appendChild(conclusionElement);
            debateSpace.scrollTop = debateSpace.scrollHeight;
            
            // Add to debate record
            currentDebate.phases.push({
                phase: '主持人总结',
                round: 0,
                side: 'moderator',
                speaker: '主持人',
                message: conclusion,
                timestamp: new Date().toISOString(),
                isQuestion: false
            });
            
            // Add delay before debate ends
            await new Promise(resolve => setTimeout(resolve, 3000));
        }
        
        // Generate AI response using API
        async function generateAIReponse(ai, phase, round, opponent = null, isQuestion = false) {
            const debateSpace = document.getElementById('debate-space');
            
            // Show loading indicator
            const loadingMsg = document.createElement('div');
            loadingMsg.className = `debate-message debate-message-${opponent ? 'negative' : 'affirmative'} full`;
            loadingMsg.style.textAlign = 'center';
            loadingMsg.innerHTML = `
                <div class="debate-message-header">
                    <div class="debate-message-sender">${ai.name} 思考中...</div>
                </div>
                <div class="debate-message-content pulse">${ai.name} 正在生成回应...</div>
            `;
            debateSpace.appendChild(loadingMsg);
            
            try {
                // Prepare prompt based on debate phase
                let prompt = '';
                let role = '';
                
                switch (phase) {
                    case '开篇立论':
                        role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是开篇立论阶段。请发表你方的立论观点，时间3分钟。`;
                        break;
                        
                    case '质询环节':
                        if (isQuestion) {
                            role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是质询环节。作为${ai.name}，请向对方${opponent.name}提出一个尖锐的问题，时间2分钟。`;
                        } else {
                            role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是质询环节。作为${ai.name}，请回答对方${opponent.name}的问题，回答时间2分钟。`;
                        }
                        break;
                        
                    case '三辩盘问':
                        if (isQuestion) {
                            role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是三辩盘问环节。作为${ai.name}，请向对方${opponent.name}提出一个关键问题，时间1分30秒。`;
                        } else {
                            role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是三辩盘问环节。作为${ai.name}，请回答对方${opponent.name}的问题，回答时间1分30秒。`;
                        }
                        break;
                        
                    case '质询小结':
                        role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是质询小结环节。请总结之前的质询交锋内容，时间1分30秒。`;
                        break;
                        
                    case '自由辩论':
                        role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是自由辩论环节。请针对对方的观点进行反驳或进一步阐述你方立场，时间30秒。`;
                        break;
                        
                    case '总结陈词':
                        role = `你是一位专业辩手，正在参加关于"${debateTopic}"的辩论。你代表${ai === currentDebate.debaters.affirmative[0] ? '正方' : '反方'}，现在是总结陈词环节。请总结你方的主要观点和论据，时间3分30秒。`;
                        break;
                        
                    case '主持人开场':
                    case '主持人总结':
                        role = `你是一位专业辩论主持人，正在主持一场关于"${debateTopic}"的辩论。${phase === '主持人开场' ? '请介绍这场辩论的主题、双方辩手和辩论规则。' : '请总结这场辩论，分别总结正方和反方的主要观点，并给出你的最终评价。'}`;
                        break;
                }
                
                // Add any custom instructions
                if (ai.instructions) {
                    role += `\n\n特别指令: ${ai.instructions}`;
                }
                
                // Add instruction to include "我的发言完毕"
                role += `\n\n请在发言结束时务必包含"我的发言完毕"这几个字。`;
                
                // Call OpenAI API
                const response = await callOpenAIAPI(ai, [
                    { role: "system", content: role },
                    { role: "user", content: `当前辩论主题: ${debateTopic}\n当前阶段: ${phase}\n请发表你的观点:` }
                ]);
                
                // Remove loading indicator
                debateSpace.removeChild(loadingMsg);
                
                // Wait for "我的发言完毕" if response is complete
                if (response.includes("我的发言完毕")) {
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
                
                return response;
            } catch (error) {
                console.error('Error generating AI response:', error);
                debateSpace.removeChild(loadingMsg);
                return `${ai.name} 在生成回应时出错: ${error.message}`;
            }
        }
        
        // Call OpenAI API
        async function callOpenAIAPI(ai, messages) {
            let apiUrl = ai.baseUrl;
            
            // Ensure the base URL ends with /v1 or /competition
            if (!apiUrl.endsWith('/v1') && !apiUrl.endsWith('/competition')) {
                apiUrl = apiUrl.endsWith('/') ? apiUrl + 'v1' : apiUrl + '/v1';
            }
            
            apiUrl = `${apiUrl}/chat/completions`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ai.apiKey}`
                },
                body: JSON.stringify({
                    model: ai.model,
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 500
                })
            });
            
            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // Display debate message in debate space
        function displayDebateMessage(roundData) {
            const debateSpace = document.getElementById('debate-space');
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `debate-message debate-message-${roundData.side} full`;
            messageElement.setAttribute('data-round', currentDebate.phases.length - 1);
            
            messageElement.innerHTML = `
                <div class="debate-message-header">
                    <div class="debate-message-sender">${roundData.speaker}${roundData.isQuestion ? ' 质询' + (roundData.opponent ? ' ' + roundData.opponent : '') : ''}</div>
                    <div class="debate-message-time">${new Date(roundData.timestamp).toLocaleTimeString()}</div>
                </div>
                <div class="debate-message-content">${roundData.message}</div>
            `;
            
            debateSpace.appendChild(messageElement);
            
            // Scroll to bottom
            debateSpace.scrollTop = debateSpace.scrollHeight;
            
            // After 3 seconds, collapse the message
            setTimeout(() => {
                messageElement.classList.remove('full');
                messageElement.classList.add('collapsed');
                
                // Keep only a portion of the text visible
                const content = messageElement.querySelector('.debate-message-content');
                const shortText = content.textContent.substring(0, 50) + (content.textContent.length > 50 ? '...' : '');
                content.textContent = shortText;
                
                // Add click handler to show full message
                messageElement.addEventListener('click', () => {
                    showRoundDetails(currentDebate.phases.length - 1);
                });
            }, 3000);
        }
        
        // Show round details in modal
        function showRoundDetails(roundIndex) {
            if (!currentDebate || roundIndex >= currentDebate.phases.length) return;
            
            const round = currentDebate.phases[roundIndex];
            
            // Find the corresponding round from the other side
            let oppositeRound = null;
            if (round.side !== 'moderator') {
                oppositeRound = currentDebate.phases.find(r => 
                    r.phase === round.phase && 
                    r.round === round.round && 
                    r.side !== round.side &&
                    r.side !== 'moderator'
                );
            }
            
            // Prepare modal content
            const modalContent = document.getElementById('round-details-content');
            modalContent.innerHTML = `
                <h3>${round.phase} - 第 ${round.round + 1} 回合</h3>
                <p><strong>辩题:</strong> ${currentDebate.topic}</p>
                <p><strong>时间:</strong> ${new Date(round.timestamp).toLocaleString()}</p>
                
                <div class="round-details">
                    <div class="round-side round-affirmative">
                        <div class="round-side-header">正方: ${round.side === 'affirmative' ? round.speaker : (oppositeRound && oppositeRound.side === 'affirmative' ? oppositeRound.speaker : '无')}</div>
                        <div class="round-content">
                            ${round.side === 'affirmative' ? round.message : (oppositeRound && oppositeRound.side === 'affirmative' ? oppositeRound.message : '无')}
                        </div>
                    </div>
                    
                    <div class="round-side round-negative">
                        <div class="round-side-header">反方: ${round.side === 'negative' ? round.speaker : (oppositeRound && oppositeRound.side === 'negative' ? oppositeRound.speaker : '无')}</div>
                        <div class="round-content">
                            ${round.side === 'negative' ? round.message : (oppositeRound && oppositeRound.side === 'negative' ? oppositeRound.message : '无')}
                        </div>
                    </div>
                </div>
                
                ${round.side !== 'moderator' ? `
                <h4 style="margin-top: 20px;">总结</h4>
                <div style="background: rgba(30, 30, 60, 0.5); padding: 10px; border-radius: 5px;">
                    ${currentDebate.summaries.find(s => s.phase === round.phase && s.round === round.round && s.side === round.side)?.summary || '暂无总结'}
                </div>
                ` : ''}
            `;
            
            // Show modal
            document.getElementById('round-details-modal').style.display = 'flex';
        }
        
        // End debate
        function endDebate() {
            clearTimeout(debateInterval);
            
            addSystemMessage('辩论结束！');
            currentDebate.status = 'completed';
            currentDebate.endTime = new Date().toISOString();
            
            // Add to history
            debateHistory.unshift(currentDebate);
            saveData();
            renderHistoryList();
            
            // Re-enable seat selection
            document.querySelectorAll('.debater-seat').forEach(seat => {
                seat.style.pointerEvents = 'auto';
            });
            
            // Re-enable start button
            document.querySelector('.debate-controls .btn').disabled = false;
        }
        
        // Reset debate
        function resetDebate() {
            if (confirm('确定要重置辩论吗？这将清除所有辩手分配和当前辩论内容。')) {
                clearTimeout(debateInterval);
                
                // Clear seat assignments
                document.querySelectorAll('.debater-seat').forEach(seat => {
                    seat.classList.remove('occupied');
                    seat.querySelector('.debater-name').textContent = '点击选择AI';
                    seat.querySelector('.debater-model').textContent = '未分配';
                    seat.querySelector('.debater-instructions').style.display = 'none';
                    seat.querySelector('.debater-instructions textarea').value = '';
                    seat.removeAttribute('data-ai-index');
                    seat.style.pointerEvents = 'auto';
                });
                
                // Clear debate space
                document.getElementById('debate-space').innerHTML = '';
                
                // Reset debate state
                currentDebate = null;
                currentPhase = 0;
                
                // Re-enable start button
                document.querySelector('.debate-controls .btn').disabled = false;
                
                addSystemMessage('辩论已重置。');
            }
        }
        
        // View debate history
        function viewDebateHistory(index) {
            if (index < 0 || index >= debateHistory.length) return;
            
            const debate = debateHistory[index];
            const modalContent = document.getElementById('round-details-content');
            
            modalContent.innerHTML = `
                <h3>历史辩论详情</h3>
                <p><strong>辩题:</strong> ${debate.topic}</p>
                <p><strong>时间:</strong> ${new Date(debate.startTime).toLocaleString()} 至 ${new Date(debate.endTime).toLocaleString()}</p>
                <p><strong>持续时间:</strong> ${Math.floor((new Date(debate.endTime) - new Date(debate.startTime)) / 60000)} 分钟</p>
                <p><strong>回合数:</strong> ${debate.phases.length}</p>
                
                <h4 style="margin-top: 20px;">辩手</h4>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h5>正方</h5>
                        <ul>
                            ${debate.debaters.affirmative.map(d => `<li>${d.name} (${d.model})</li>`).join('')}
                        </ul>
                    </div>
                    <div style="flex: 1;">
                        <h5>反方</h5>
                        <ul>
                            ${debate.debaters.negative.map(d => `<li>${d.name} (${d.model})</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <h4>辩论记录</h4>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${debate.phases.map((round, i) => `
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(30, 30, 60, 0.5); border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${round.phase} - 第 ${i + 1} 回合 - ${round.side === 'affirmative' ? '正方' : round.side === 'negative' ? '反方' : '主持人'} ${round.speaker}
                            </div>
                            <div style="white-space: pre-wrap;">${round.message}</div>
                            ${round.side !== 'moderator' ? `
                            <div style="margin-top: 10px; font-size: 14px; color: var(--primary-color);">
                                <strong>总结:</strong> ${debate.summaries.find(s => s.phase === round.phase && s.round === round.round && s.side === round.side)?.summary || '无'}
                            </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Show modal
            document.getElementById('round-details-modal').style.display = 'flex';
        }
        
        // Delete debate history
        function deleteDebateHistory(index) {
            if (confirm('确定要删除此辩论记录吗？此操作不可撤销。')) {
                debateHistory.splice(index, 1);
                saveData();
                renderHistoryList();
                addSystemMessage('辩论记录已删除。');
            }
        }
        
        // Add system message to debate space
        function addSystemMessage(text) {
            const debateSpace = document.getElementById('debate-space');
            const now = new Date();
            
            const messageElement = document.createElement('div');
            messageElement.className = 'debate-message';
            messageElement.style.textAlign = 'center';
            messageElement.style.width = '80%';
            messageElement.style.margin = '0 auto';
            messageElement.innerHTML = `
                <div class="debate-message-header">
                    <div class="debate-message-sender">系统</div>
                    <div class="debate-message-time">${now.toLocaleTimeString()}</div>
                </div>
                <div class="debate-message-content">${text}</div>
            `;
            
            debateSpace.appendChild(messageElement);
            
            // Scroll to bottom
            debateSpace.scrollTop = debateSpace.scrollHeight;
            
            // Auto-remove after some time
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.style.opacity = '0';
                    setTimeout(() => {
                        if (messageElement.parentNode) {
                            debateSpace.removeChild(messageElement);
                        }
                    }, 500);
                }
            }, 5000);
        }
    </script>
</body>
</html>